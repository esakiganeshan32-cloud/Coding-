#include <Wire.h>
#include <LiquidCrystal_I2C.h>
#include <ESP32Servo.h>

#define VOLTAGE_PIN 32
#define CURRENT_PIN 35        // NEW : ACS712 Input Pin
#define TILT_PIN 34
#define LORA_TX 25
#define LORA_RX 26
#define GSM_TX 17
#define GSM_RX 16
#define SERVO_PIN 33
#define BUZZER_PIN 27
#define BUTTON_PIN 13

LiquidCrystal_I2C lcd(0x27, 16, 2);
HardwareSerial LORA(1);
HardwareSerial GSM(2);
Servo gateServo;

#define VOLTAGE_THRESHOLD 10
#define CURRENT_THRESHOLD 10   // NEW : If current < 10 â†’ NO CURRENT
#define TILT_THRESHOLD 2000

bool emergencyActive = false;

void setup() {
  Serial.begin(115200);
  LORA.begin(9600, SERIAL_8N1, LORA_RX, LORA_TX);
  GSM.begin(9600, SERIAL_8N1, GSM_RX, GSM_TX);

  lcd.init();
  lcd.backlight();
  lcd.clear();
  lcd.print("RX Node Ready");
  delay(1500);
  lcd.clear();

  pinMode(BUTTON_PIN, INPUT_PULLUP);
  pinMode(BUZZER_PIN, OUTPUT);
  gateServo.attach(SERVO_PIN);
  gateServo.write(0);
}

void loop() {

  if (digitalRead(BUTTON_PIN) == LOW) {
    emergencyActive = false;
    gateServo.write(0);
    digitalWrite(BUZZER_PIN, LOW);
    lcd.clear();
    lcd.print("System Reset");
    delay(1500);
    lcd.clear();
  }

  int localVoltage = analogRead(VOLTAGE_PIN);
  int tiltRaw = analogRead(TILT_PIN);
  int localTilt = (tiltRaw > TILT_THRESHOLD);

  // --------------- NEW CURRENT SENSOR READING ----------------
  int currentRaw = analogRead(CURRENT_PIN);
  int localCurrent = (currentRaw < CURRENT_THRESHOLD);  // 1 = NO CURRENT
  // -----------------------------------------------------------

  int remoteVoltage = localVoltage;
  int remoteTilt = localTilt;
  int remoteCurrent = localCurrent;

  if (LORA.available()) {
    String received = LORA.readStringUntil('\n');
    received.trim();

    int c1 = received.indexOf(',');
    int c2 = received.lastIndexOf(',');

    if (c1 > 0 && c2 > c1) {
      remoteVoltage = received.substring(0, c1).toInt();
      remoteTilt = received.substring(c1 + 1, c2).toInt();
      remoteCurrent = received.substring(c2 + 1).toInt();  
    }
  }

  lcd.setCursor(0, 0);
  lcd.print("V:");
  lcd.print(remoteVoltage);
  lcd.print(" C:");
  lcd.print(remoteCurrent);

  lcd.setCursor(0, 1);
  lcd.print("Tilt:");
  lcd.print(remoteTilt);
  lcd.print("   ");

  if (!emergencyActive) {

    // BOTH FAULTS
    if ((remoteTilt == 1 || localTilt == 1) &&
        (remoteVoltage <= VOLTAGE_THRESHOLD || localVoltage <= VOLTAGE_THRESHOLD) &&
        (remoteCurrent == 1 || localCurrent == 1)) {
      triggerEmergency("WIRE+POLE+CURRENT FAULT");
    }

    // CURRENT FAULT ONLY
    else if (remoteCurrent == 1 || localCurrent == 1) {
      triggerEmergency("NO CURRENT FLOW");
    }

    // WIRE BREAK
    else if (remoteVoltage <= VOLTAGE_THRESHOLD || localVoltage <= VOLTAGE_THRESHOLD) {
      triggerEmergency("WIRE BREAK");
    }

    // POLE FALL
    else if (remoteTilt == 1 || localTilt == 1) {
      triggerEmergency("POLE FALL");
    }
  }

  delay(500);
}

void triggerEmergency(String msg) {
  emergencyActive = true;

  lcd.clear();
  lcd.print("EMERGENCY!");
  lcd.setCursor(0, 1);
  lcd.print(msg);

  gateServo.write(60);
  digitalWrite(BUZZER_PIN, HIGH);

  Serial.println("Emergency: " + msg);
  sendSMS(msg);
}

void sendSMS(String text) {
  GSM.println("AT+CMGF=1");
  delay(500);
  GSM.println("AT+CMGS=\"+919345385535\"");
  delay(500);
  GSM.print(text);
  delay(500);
  GSM.write(26);
  delay(2000);
}
